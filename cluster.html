<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Ethereum Miner</title>
  <link href="./css/mui.min.css" rel="stylesheet" type="text/css" />
  <link href="./css/index.css" rel="stylesheet" type="text/css" />
</head>

<body>
  <div class="mui-container">
    <div class="mui-panel">
      <h1>
        <img src='./img/ethereum.png' id='icon'>Cluster Monitor</h1>
      <div class="mui--text-display3" id="total"></div>
      <div class="mui--text-display2" id="totalShares"></div>
      <h3>Add Miner to monitor</h3>
      <div class="mui-row">
        <div class="mui-col-md-12">
          <div class="mui-textfield">
            <input type="text" id="workerAddress" placeholder="http://192.168.1.5:5025">
            <label>Address</label>
          </div>
          <button class="mui-btn mui-btn--primary" onClick="addWorker();">Add</button>
        </div>
      </div>
    </div>
    <div class='mui-panel' id='tablePanel'>
      <table class='mui-table mui-table--bordered' id='clusterTable'>
      </table>
    </div>
    <script>
      const { ipcRenderer } = require('electron');
      var workers = {};
      function addWorker() {
        let address = document.getElementById('workerAddress').value;
        if (address == "") {
          ipcRenderer.send('dialog', 'No address entered');
          return;
        }
        ipcRenderer.send('addWorker', { address });
      }
      ipcRenderer.send('initClusterMonitor');
      ipcRenderer.on('update', (event, data) => {
        if (!data) return;
        let { workerName, hashrate, totalAccepted, totalAccepted2, totalRejected, totalRejected2, totalFound } = data;
        if (!workerName) return;
        workers[workerName].hashrate = hashrate;
        workers[workerName].totalAccepted = totalAccepted;
        workers[workerName].totalAccepted2 = totalAccepted2;
        workers[workerName].totalRejected = totalRejected;
        workers[workerName].totalRejected2 = totalAccepted2;
        let hashrateElement = document.getElementById(`hashrate${workerName}`)
        if (hashrateElement) {
          let floatHashrate = parseFloat(hashrate);
          if (!isNaN(floatHashrate)) {
            hashrateElement.innerHTML = floatHashrate.toFixed(2);
          } else {
            hashrateElement.innerHTML = hashrate;
          }
        }
        let sharesElement = document.getElementById(`shares${workerName}`);
        if (sharesElement) sharesElement.innerHTML = `A${totalAccepted}+${totalAccepted2}:R${totalRejected}+${totalRejected2}:F${totalFound}`;
        calculateTotal();
      });

      function calculateTotal() {
        let keys = Object.keys(workers);
        var total = 0;
        var totalAccepted = 0, totalAccepted2 = 0, totalRejected = 0, totalRejected2 = 0, totalFound = 0;
        for (i = 0; i < keys.length; i++) {
          let workerName = keys[i];
          let worker = workers[workerName];
          if (!worker.enabled) continue;
          if (worker.hashrate && !isNaN(worker.hashrate)) total += worker.hashrate;
          if (worker.totalAccepted) totalAccepted += worker.totalAccepted;
          if (worker.totalAccepted2) totalAccepted2 += worker.totalAccepted2;
          if (worker.totalRejected) totalRejected += worker.totalRejected;
          if (worker.totalRejected2) totalRejected2 += worker.totalRejected2;
          if (worker.totalFound) totalFound += worker.totalFound;
        }
        document.getElementById('total').style.display = 'block';
        document.getElementById('total').innerHTML = `${total.toFixed(2)} Mh/s`;
        document.getElementById('totalShares').style.display = 'block';
        document.getElementById('totalShares').innerHTML = `A${totalAccepted}+${totalAccepted2}:R${totalRejected}+${totalRejected2}:F${totalFound}`;
      }

      function deleteWorker(event) {
        if (!event || !event.target) return;
        let workerName = event.target.getAttribute("workerName");
        ipcRenderer.send('deleteWorker', workerName);
      }

      function disableWorker(event) {
        if (!event || !event.target) return;
        //event.target.setAttribute('disabled', 'disabled');
        let workerName = event.target.getAttribute("workerName");
        if (!workerName) return;
        let sharesElement = document.getElementById(`shares${workerName}`);
        let hashrateElement = document.getElementById(`hashrate${workerName}`);
        let monitorElement = document.getElementById(`monitor${workerName}`);
        if (workers[workerName]) {
          if (workers[workerName].enabled) {
            if (hashrateElement) hashrateElement.innerHTML = "";
            if (sharesElement) sharesElement.innerHTML = "";
            ipcRenderer.send('disableWorker', workerName);
            event.target.innerHTML = "Enable";
          } else {
            event.target.innerHTML = "Disable";
            ipcRenderer.send('enableWorker', workerName);
          }
          workers[workerName].enabled = !workers[workerName].enabled
        }


      }

      ipcRenderer.on('cluster', (event, data) => {
        var clusterTable = `<tr><th>Worker Name</th><th>Address</th><th>Hashrate</th><th>Shares</th><th>Delete</th><th>Monitor</th></tr>`;
        if (data) {
          for (i = 0; i < data.length; i++) {
            let { workerName, address } = data[i];
            workers[workerName] = { enabled: true };
            clusterTable += `<tr><td>${workerName}</td><td>${address}</td><td id='hashrate${workerName}'></td><td id='shares${workerName}'></td><td><button class="mui-btn mui-btn--danger" workerName='${workerName}' onClick="return deleteWorker(event);">Delete</button></td><td><button class="mui-btn mui-btn--primary"  workerName='${workerName}' onClick="return disableWorker(event);">Disable</button></td></tr>`;
          }
        }
        document.getElementById('clusterTable').innerHTML = clusterTable;
      });
      const mui = require('./js/mui.min.js')
    </script>
</body>

</html>